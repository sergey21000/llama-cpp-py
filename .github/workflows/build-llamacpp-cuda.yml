name: Build llama.cpp CUDA (linux x64)

on:
  workflow_dispatch:

permissions:
  contents: write

env:
  CMAKE_ARGS: >
    -DGGML_CUDA=ON
    -DLLAMA_BUILD_EXAMPLES=OFF
    -DLLAMA_BUILD_TESTS=OFF
    -DLLAMA_BUILD_SERVER=ON
    # -DCMAKE_CUDA_ARCHITECTURES=75

jobs:
  linux-cuda:
    runs-on: ubuntu-22.04

    strategy:
      matrix:
        cuda: ['12.4.1']

    steps:
      - name: Checkout llama.cpp
        uses: actions/checkout@v6
        with:
          repository: ggml-org/llama.cpp
          ref: master
          fetch-depth: 0

      - name: ccache
        uses: ggml-org/ccache-action@v1.2.16
        with:
          key: linux-cuda-${{ matrix.cuda }}
          evict-old-files: 1d

      - name: Clean up disk space before build
        run: |
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          docker system prune -af || true

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential libssl-dev

      - name: Install CUDA Toolkit
        uses: Jimver/cuda-toolkit@v0.2.16
        with:
          cuda: ${{ matrix.cuda }}

      - name: Build
        run: |
          cmake -B build \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_INSTALL_RPATH='$ORIGIN' \
            -DCMAKE_BUILD_WITH_INSTALL_RPATH=ON \
            $CMAKE_ARGS
          cmake --build build --config Release -j $(nproc)

      - name: Determine tag name
        id: tag
        run: |
          TAG=$(git describe --tags --always --abbrev=0 2>/dev/null || echo "b$(git rev-list --count HEAD)")
          echo "name=$TAG" >> $GITHUB_OUTPUT
          echo "Tag name: $TAG"

      - name: Pack artifacts
        run: |
          cp LICENSE ./build/bin/
          tar -czvf llama-${{ steps.tag.outputs.name }}-bin-ubuntu-cuda-${{ matrix.cuda }}-x64.tar.gz \
            --transform "s,./,llama-${{ steps.tag.outputs.name }}/," -C ./build/bin .

      - name: Upload artifacts
        uses: actions/upload-artifact@v6
        with:
          name: llama-bin-ubuntu-cuda-${{ matrix.cuda }}-x64
          path: llama-${{ steps.tag.outputs.name }}-bin-ubuntu-cuda-${{ matrix.cuda }}-x64.tar.gz

      - name: Create or update release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.tag.outputs.name }}
          name: ${{ steps.tag.outputs.name }} (CUDA)
          files: llama-${{ steps.tag.outputs.name }}-bin-ubuntu-cuda-${{ matrix.cuda }}-x64.tar.gz
          body: |
              Prebuilt llama.cpp binaries with CUDA support for Linux x64.
              CUDA version: ${{ matrix.cuda }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}